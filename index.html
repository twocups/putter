<html>
  <head>
    <title>Putting Game Scorer</title>
    <script src="lib/underscore-min.js"></script>
    <script src="lib/react-0.12.2.js"></script>
    <script src="lib/JSXTransformer-0.12.2.js"></script>
    <script src="lib/jquery-1.10.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link href="bootstrap/css/orig.bootstrap.min.css" rel="stylesheet" >
    <link href="style.css" rel="stylesheet" >
    <link href="images/touchicon-180x180.png" rel="apple-touch-icon" />
    <link href="images/touchicon-180x180.png" rel="icon" />
  </head>
  <body>
    <div id="content" class="container">
      Loading... please wait<br /><br />
      If nothing happens and you definitely have network connection then you can reset the app by clicking <a href="?reset=true">here</a>. <strong>This will destroy all your data!</strong>
    </div>
    <script type="text/jsx">

    /* 
      work in progress !!
      james@5point6.net on behalf of the disc golf community 
    */

var GameHistoryRow = React.createClass({
        getInitialState : function() {
            return {hiddenRow: true};
        },
        showDetails: function(e) {
          e.preventDefault();
          this.setState({hiddenRow: !this.state.hiddenRow});
          var message="Stats for game:\n";
          message+="\n5m   : " + this.props.five +"%";
          message+="\n6m   : " + this.props.six +"%";
          message+="\n7m   : " + this.props.seven +"%";
          message+="\n8m   : " + this.props.eight +"%";
          message+="\n9m   : " + this.props.nine +"%";
          message+="\n10m  : " + this.props.ten +"%";
          message+="\nTotal: " + this.props.totalPercent +"%";
          alert(message);
        },
        deleteGame: function(e) {
          e.preventDefault();
          this.props.deleteGameHandler(this.props.gameIndex);
        },
        render: function() { 
      
          /*
          var hiddenRow="";
          if(!this.state.hiddenRow) {
              hiddenStyle={};
              hiddenRow=<tr><td colSpan="3">
              
                  <table className="table">
                      <thead>
                        <th>5m</th>
                        <th>6m</th>
                        <th>7m</th>
                        <th>8m</th>
                        <th>9m</th>
                        <th>10m</th>
                      </thead>
                      <tbody>
                        <GameHistoryInnerRow five={this.props.five} six={this.props.six} seven={this.props.seven} eight={this.props.eight} nine={this.props.nine} ten={this.props.ten}  />
                      </tbody>
                    </table>
              </td>
            </tr>
            
          };
          */

          
          return (
              <tr>
                  <td><a onClick={this.showDetails} href="#">{this.props.date}</a>
                  </td>
                  <td>{this.props.totalPercent}%</td>
                  <td>{this.props.totalPoints}</td>
                  <td>
                  <div className="btn-group">
                    <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                      Delete&nbsp;
                      <span className="caret"></span>
                    </button>
                    <ul className="dropdown-menu dropdown-menu-right" role="menu" >
                      <li  onClick={this.deleteGame} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, delete this game</a></li>
                    </ul>
                  </div> 
                  </td>
            </tr>
            );
            

           
           

          
        
          }
      });


      var GameHistoryInnerRow = React.createClass({
        render: function() {
          return (
            <tr>
              <td>{this.props.five}</td>
              <td>{this.props.six}</td>
              <td>{this.props.seven}</td>
              <td>{this.props.eight}</td>
              <td>{this.props.nine}</td>
              <td>{this.props.ten}</td>
            </tr>
          );
        }
      });

      var Frag = React.createClass({
        render: function() {
          return this.props.children;
        }
      });



    var GameHistory = React.createClass({
        getInitialState : function() {
            return {truncateHistory: true};
        },
        showMoreToggle: function() {
            this.setState({truncateHistory: !this.state.truncateHistory});
        },
        deleteGameHandler: function(game) {
          this.props.deleteGameHandler(game);
        },
        render: function() {
          
            var amountToShow=5;
            var truncateHistory=this.state.truncateHistory;

            var truncateStart=this.props.history.length-amountToShow;
            if(truncateStart < 0) {truncateStart=0;}

            var historyList=this.props.history;
            if(truncateHistory) {
              historyList=_.rest(historyList,truncateStart);
            } else {
              historyList=this.props.history;
              truncateStart=0;
            }
            var deleteGameHandler=this.deleteGameHandler;
            var rows = historyList.map(function (data,index) {
      
              var datemsec=Date.parse(data.date);
              var theDate=new Date(datemsec);
              var date=theDate.getDate() + '/' + (theDate.getMonth()+1 + '/' + theDate.getFullYear());
            
              
              
              return (
                <GameHistoryRow 
                  deleteGameHandler={deleteGameHandler} 
                  gameIndex={index+truncateStart} 
                  date={date} 
                  five= {Math.round((data.scores['5'].scored / (data.scores['5'].numThrows+0.00001)) *100) } 
                  six=  {Math.round((data.scores['6'].scored / (data.scores['6'].numThrows+0.00001)) *100)} 
                  seven={Math.round((data.scores['7'].scored / (data.scores['7'].numThrows+0.00001)) *100)} 
                  eight={Math.round((data.scores['8'].scored / (data.scores['8'].numThrows+0.00001)) *100)} 
                  nine= {Math.round((data.scores['9'].scored / (data.scores['9'].numThrows+0.00001)) *100)} 
                  ten=  {Math.round((data.scores['10'].scored / (data.scores['10'].numThrows+0.00001)) *100)} 
                  totalPoints={data.scores['total'].points} 
                  totalPercent={Math.round((data.scores['total'].scored  / (data.scores['total'].numThrows+0.00001)) *100)} />
                );
            
            /*
              return (
                <GameHistoryRow 
                  date={date} 
                  totalPoints={data.scores['total'].points} 
                  totalPercent={Math.round((data.scores['total'].scored  / (data.scores['total'].numThrows+0.00001)) *100)} />
                );
              */
          });

          var showMore="";
          if(truncateHistory && this.props.history.length > amountToShow) {
            showMore=<div className="row">
              <div className="col-xs-12 text-center">
                  <button onClick={this.showMoreToggle} type="button" className="btn btn-info" >Show more history</button>
              </div>
            </div>
          } else {
            if(this.props.history.length > amountToShow) {
              showMore=<div className="row">
              <div className="col-xs-12 text-center">
                  <button onClick={this.showMoreToggle} type="button" className="btn btn-info" >Show less history</button>
              </div>
            </div>
            }

          }

          //sumayr panel
          var numberStyle={fontSize: "40px", fontWeight: "bold"};
          var numberUnitStyle={fontSize: "20px", fontWeight: "bold"};
          var totalScore=0;


          //calc last 3 average
          var recent=this.props.history;
          var startIndex=recent.length-3;
          if(startIndex < 0) {startIndex=0;}
          _.each(_.rest(recent,startIndex),function(data){
            totalScore=totalScore+data.scores.total.points;
          });
    
          var divider=3;
          if(this.props.history.length <3 ) {divider=this.props.history.length ;}
          var totalAverage=0;
          if(divider>0) {totalAverage=Math.round(totalScore/divider); }
          

          var bestScore=0;
          _.each(this.props.history,function(data){
            if(data.scores.total.points > bestScore) {bestScore=data.scores.total.points};
          });

          var summaryPanel=<div>
                  <div  className="well" >
                  <div className="row">
                      <div className="col-xs-4 text-center">
                        Rounds<br />Played
                      </div>
                      <div className="col-xs-4 text-center">
                        Average<br />Last 3
                      </div>
                      <div className="col-xs-4 text-center">
                        Best<br/>Score
                      </div>
                    </div>
                    <div className="row">
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{this.props.history.length}</p>
                      </div>
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{totalAverage}</p>
                      </div>
                       <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{bestScore}</p>
                      </div>
                    </div>
                  </div>
                   
                  </div>;

           


          return (
           <div>
           {summaryPanel}
              <table className="table table-striped">
                <thead>
                  <tr>
                  <th className="col-xs-3">Date</th>
                  <th  className="col-xs-3">Scored</th>
                  <th  className="col-xs-3">Points</th>
                  <th className="col-xs-3">&nbsp;</th>
                  </tr>
                  </thead>
                  <tbody>
                    {rows}
                  </tbody>
                  
              </table>   
                {showMore}
            </div>
          );
        }
      });

      //History row
      var HistoryPanel = React.createClass({
        handleDeleteLastResult: function() {
          this.props.handleDeleteLastResult();
        },
        render: function() {
          var accumulatedPoints=0;
          var rows = this.props.history.map(function (data) {
            accumulatedPoints=accumulatedPoints+data.points;
            return (
              <HistoryRow round={data.round} fromPosition={data.fromPosition} score={data.score} points={data.points} totalPoints={accumulatedPoints}/>
              );
          });

          var panelTitle="Scorecard for "+ this.props.playerName;

          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">{panelTitle}</h3>
                  </div>                  
                  <div className="panel-body" >
                      <table className="table table-striped">
                        <thead><th>#</th><th>From</th><th>Score</th><th>Points</th><th>Total</th></thead>
                        <tbody>
                          {rows}
                        </tbody>
                      </table>
                  <div className="well text-center" >
                    You can copy and paste these details and email yourself!
                  </div>
                  <div className="text-center">
                  <div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Delete last score&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleDeleteLastResult} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, delete the last score</a></li>
                  </ul>
                </div> 
                </div> 
                  </div>
                </div>
              </div>
            </div>
          );
        }
      });


      //History row
      var HistoryRow = React.createClass({
        render: function() {
          return (
            <tr>
              <td>{this.props.round}</td>
              <td>{this.props.fromPosition+'m'}</td>
              <td>{this.props.score}</td>
              <td>{this.props.points}</td>
              <td>{this.props.totalPoints}</td>

            </tr>
          );
        }
      });

      //Container for form etc
      var BasicPanel = React.createClass({
        render: function() {
          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">{this.props.title}</h3>
                  </div>                  
                  <div className="panel-body" >{this.props.children}</div>
                </div>
              </div>
            </div>
          );
        }
      });

      
      var RoundGraphs = React.createClass({
        render: function() {

          var distanceStats={
            "5" : {scored: 0, numThrows: 0, points: 0},
            "6" : {scored: 0, numThrows: 0, points: 0},
            "7" : {scored: 0, numThrows: 0, points: 0},
            "8" : {scored: 0, numThrows: 0, points: 0},
            "9" : {scored: 0, numThrows: 0, points: 0},
            "10" : {scored: 0, numThrows: 0, points: 0},
            "total":  {scored: 0, numThrows: 0, points: 0},
          };

          var numThrows=this.props.roundData.length*5;
          var totalPoints=0;
          var throwsPerTurn=5;

          this.props.roundData.map(function (data) {
            distanceStats[data.fromPosition].scored=parseInt(distanceStats[data.fromPosition].scored)+parseInt(data.score);
            distanceStats[data.fromPosition].numThrows=parseInt(distanceStats[data.fromPosition].numThrows)+throwsPerTurn;
            distanceStats[data.fromPosition].points=parseInt(distanceStats[data.fromPosition].points)+parseInt(data.points);

            distanceStats['total'].scored=parseInt(distanceStats['total'].scored)+parseInt(data.score);
            distanceStats['total'].numThrows=parseInt(distanceStats['total'].numThrows)+throwsPerTurn;
            distanceStats['total'].points=parseInt(distanceStats['total'].points)+parseInt(data.points);


          });



          var numThowsOffset=numThrows+0.000001;
          
          return (
            <div>
                  <table className="table table-striped">
                    <thead><th>Distance</th><th>Scored</th><th>%</th><th>Points</th></thead>
                    <tbody>
                     <RoundGraphsRow distance="5m" score={distanceStats['5'].scored+'/'+distanceStats['5'].numThrows} percent={Math.round((distanceStats['5'].scored/(distanceStats['5'].numThrows+0.0001))*100,2)} points={distanceStats['5'].points} />
                     <RoundGraphsRow distance="6m" score={distanceStats['6'].scored+'/'+distanceStats['6'].numThrows} percent={Math.round((distanceStats['6'].scored/(distanceStats['6'].numThrows+0.0001))*100,2)} points={distanceStats['6'].points} />
                     <RoundGraphsRow distance="7m" score={distanceStats['7'].scored+'/'+distanceStats['7'].numThrows} percent={Math.round((distanceStats['7'].scored/(distanceStats['7'].numThrows+0.0001))*100,2)} points={distanceStats['7'].points} />
                     <RoundGraphsRow distance="8m" score={distanceStats['8'].scored+'/'+distanceStats['8'].numThrows} percent={Math.round((distanceStats['8'].scored/(distanceStats['8'].numThrows+0.0001))*100,2)} points={distanceStats['8'].points} />
                     <RoundGraphsRow distance="9m" score={distanceStats['9'].scored+'/'+distanceStats['9'].numThrows} percent={Math.round((distanceStats['9'].scored/(distanceStats['9'].numThrows+0.0001))*100,2)} points={distanceStats['9'].points} />
                     <RoundGraphsRow distance="10m" score={distanceStats['10'].scored+'/'+distanceStats['10'].numThrows} percent={Math.round((distanceStats['10'].scored/(distanceStats['10'].numThrows+0.0001))*100,2)} points={distanceStats['10'].points} />
                     <RoundGraphsRow distance="Total" score={distanceStats['total'].scored+'/'+distanceStats['total'].numThrows} percent={Math.round((distanceStats['total'].scored/(distanceStats['total'].numThrows+0.0001))*100,2)} points={distanceStats['total'].points} />
                    </tbody>
                  </table>
            </div>
          );
        }
      });


      var RoundGraphsRow = React.createClass({
        render: function() {
          var progstyle={width: this.props.percent+"%"};
          return (
            <tr>
              <td>{this.props.distance}</td>

              <td>{this.props.score}</td>
              <td>
                 {this.props.percent}%
              </td>
              <td>{this.props.points}</td>
            </tr>
      

          );
        }
      });

    //Score submit form
     var PlayerSettingsForm = React.createClass({
       getInitialState: function() {
        return {playerName: this.props.playerName};
      },
      componentWillReceiveProps: function(props) {
        this.setState({
          playerName: props.playerName
        });
      },
      handleSubmit: function(e) {
        e.preventDefault();
        var newPlayerName = this.refs.playerName.getDOMNode().value.trim();
        if(newPlayerName!="") {
          this.props.handlePlayerSettings({playerName: newPlayerName});
         // this.refs.playerName.getDOMNode().value = newPlayerName;
        }

        $(document.body).scrollTop($('#start').offset().top);

        
      },
      handleChange: function(event) {
        this.setState({playerName: event.target.value.substr(0, 140)});
      },
      render: function() {
        

        return (
          <form  onSubmit={this.handleSubmit} >
            <div className="row">
              <div className="col-xs-3">
                <label>Name:</label>
              </div>
              <div className="col-xs-6">
                <input onChange={this.handleChange} ref="playerName" className="form-control" type="text" placeholder="Name" value={this.state.playerName} />
              </div>
            </div>
            <div className="row">&nbsp;</div>
            <div className="row">
              <div className="col-xs-3" />
              <div className="col-xs-6">
                  <button type="button" className="btn btn-primary" type="submit" >Save</button>
              </div>
            </div>
          </form>
        );
      }
    });




    //Score submit form
     var ScoreForm = React.createClass({
      gotoNextPlayer : function() {
        this.props.gotoNextPlayer();
      },
      handleReset: function() {
        this.props.handleScoreReset();
      },
      handleSubmit: function(e) {
        e.preventDefault();

        var score = e.target.value;

        if(score >=0 && score <=5) {
          //pass to parent handler
          this.props.handleScoreSubmit({score: score});
        } else {
          alert('Bad score, must be between 0 and 5!')
        }
        $(document.body).scrollTop($('#start').offset().top);

        
      },
      render: function() {
        var nextPlayer=<div><div>&nbsp;</div>  
              <div className="text-center">
                 <button type="button" className="btn btn-info" onClick={this.gotoNextPlayer} value="0" type="submit" >Next player</button>
              </div></div>
        if(!this.props.showNextPlayer) {nextPlayer="";}

        var scoreButtons="";

        if(this.props.showScoreButtons) {
            scoreButtons=<div>
              <div className="row" >
                <div className="col-xs-12 text-center">Enter score for <strong>{this.props.playerName}</strong> for round <strong>{this.props.round}</strong> (from {this.props.fromPosition+'m'})<br /><br /></div>
            </div>
              <div className="text-center">
                       <button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="0" type="submit" >&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="1" type="submit" >&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="2" type="submit" >&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;</button>
                </div>
              <div>&nbsp;</div>  
                <div className="text-center">
                       <button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="3" type="submit" >&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="4" type="submit" >&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="5" type="submit" >&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;</button>
                </div>
            </div>
        } else {
          scoreButtons=
          <div>
            <div className="row" >
              <div className="col-xs-12">
                <p className="text-center">There are no more rounds to play for this player.</p>
              </div>
            </div>
            <div className="row" >
              <div className="col-xs-12 text-center">
                  <div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Start new game&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleReset} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, reset scores and start again</a></li>
                  </ul>
             </div> 
              </div>
            </div>
          </div>

        }

        return (
          <form  onSubmit={function(e) {e.preventDefault()}} >
            {scoreButtons}
            {nextPlayer}

          </form>
        );
      }
    });



      //Stats panel
      var StatsPanel = React.createClass({
        render: function() {
          var numberStyle={fontSize: "40px", fontWeight: "bold"};
          var numberUnitStyle={fontSize: "20px", fontWeight: "bold"};
          var progress=Math.floor(((this.props.round-1)/this.props.totalRounds) * 100) +"%";
          var progressText=progress//this.props.round+" / "+this.props.totalRounds;

          var gameScoreLine;

          if(this.props.round > this.props.totalRounds) {
                gameScoreLine=<div>
                <div  className="well" >
                  <div className="row">
                        <div className="col-xs-12 text-center">
                          <p style={numberStyle}>Total  {this.props.totalPoints}</p>
                        </div>

                  </div>
                </div>
                <ProgressBar progress={progress} progressText={progressText} />
                </div>
                ;


          } else {

             gameScoreLine=<div>
                  <div  className="well" >
                  <div className="row">
                      <div className="col-xs-4 text-center">
                        Round
                      </div>
                      <div className="col-xs-4 text-center">
                        Position
                      </div>
                      <div className="col-xs-4 text-center">
                        Points
                      </div>
                    </div>
                    <div className="row">
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >#{this.props.round}</p>
                      </div>
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{this.props.fromPosition}<span style={numberUnitStyle}>m</span></p>
                      </div>
                       <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{this.props.totalPoints}</p>
                      </div>
                    </div>
                  </div>
                    <ProgressBar progress={progress} progressText={progressText}/>
                  </div>;

           }
          var playerName=this.props.playerName;
          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">Player: {playerName}</h3>
                  </div>                  
                  <div className="panel-body" >
                      {gameScoreLine}
                  </div>
                </div>
              </div>
            </div>
          );
        }
      });

    var ProgressBar = React.createClass({
      render: function() {
        var progressStyle={width: this.props.progress};
        return(
        <div className="progress">
          <div className="progress-bar progress-bar-striped" role="progressbar"  style={progressStyle}>{this.props.progressText}</div>
        </div>);
      }

    });


    var ResetPanel = React.createClass({
      handleReset : function() {
          this.props.handleScoreReset();
      },
      handleDeletePlayer: function() {
          this.props.handleDeletePlayer();
      },
      handleResetAll: function() {
          this.props.handleScoreResetAll();
      },
      render: function() {
        return(
          <div>
            <div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Reset scores&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleReset} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, reset just this players scores</a></li>
                    <li onClick={this.handleResetAll} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, reset <strong>ALL</strong> players scores</a></li>
                  </ul>
             </div> 
     
              { " " }<div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Delete player&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleDeletePlayer} role="presentation"><a role="menuitem" tabIndex="-1" href="#">Confirm, delete this player</a></li>
                  </ul>
                </div>  
   
        

        </div>

       );
      }

    });


    var CDGCPanel = React.createClass({
      handleReset : function() {
          this.props.handleScoreReset();
      },
      render: function() {
        var center={textAlign:"center"}
        return(
          <div className="row">
              <div className="col-xs-12 col-md-5">
            <div style={center}>
              <a target="_blank" href="http://www.croydondiscgolf.com">
                <img src="images/cdgc.png" alt="Croydon Disc Golf Club" />
              </a>
              <p className="text-center">Croydon Disc Golf Club</p>
              <p className="text-center">London{"\'"}s only fully basketed disc golf course </p>
              <p className="text-center"><em>v1.0 Super beta!</em></p>
            </div>
          </div>
          </div>

       );
      }

    });

  
   var PlayerListRow = React.createClass({
      handlePlayerLink: function(e) {
         e.preventDefault();
        this.props.handlePlayerLink(e);
      },
      render: function(){
        var playerLink="?player="+this.props.name;
        var currentPlayerStyle={};
        if(this.props.selected) {currentPlayerStyle={fontWeight:"bold"};}

        return (
            <tr>
              <td><a onClick={this.handlePlayerLink} data-player={this.props.playerNumber} style={currentPlayerStyle} href="">{this.props.name}</a></td>
              <td>{this.props.round}</td>
              <td>{this.props.nextPosition + 'm'}</td>
              <td>{this.props.points}</td>
            </tr>
          );       
      }
    }); 

  var PlayerList = React.createClass({
      handlePlayerLink: function(e) {
        this.props.handlePlayerLink(e);
      },
      handleAddPlayer: function() {
        this.props.addNewPlayer();
      },
      render: function(){
        var thisThing=this;
        var currentPlayer=this.props.currentPlayer;
        var rows = this.props.players.map(function (data,index) {
          var accumulatedPoints=0;
          data.history.map(function (data) {
            accumulatedPoints=accumulatedPoints+data.points;
          });

          return (
            <PlayerListRow handlePlayerLink={thisThing.handlePlayerLink} selected={currentPlayer==index} playerNumber={index} name={data.playerName} round={data.currentRound-1} nextPosition={data.fromPosition} points={accumulatedPoints}/>
            );
        });
        return (
          <div className="row">
            <div className="col-xs-12 col-md-5">
              <div className="panel panel-primary">
                <div className="panel-heading">
                  <h3 className="panel-title">Players</h3>
                </div>                  
                <div className="panel-body" >
                   <table className="table table-striped">
                    <thead><th>Player</th><th>Played</th><th>Next</th><th>Points</th></thead>
                    <tbody>
                      {rows}
                    </tbody>
                  </table>
                  <div className="text-center">
                    <button className="btn btn-info" onClick={this.handleAddPlayer}>Add another player</button> 
                  </div>

                </div>
              </div>
            </div>
          </div> 
          );       
      }
    }); 


    var Page = React.createClass({
      getInitialState: function() {

        //load settings from local storage
        var data=false;
        var returnData;

        //get player from url
        var resetQ=getParameterByName('reset');
        var doReset=false;
        if(resetQ=="true") {
            doReset=true;
        }
       

        if(typeof(Storage)!=='undefined') {
          
          //get pre-existing data store
          if(localStorage['scores'] && !doReset) {
            data=JSON.parse(localStorage['scores']);
          }

          //first run, create a default the data storage object
          if(!data) {
            var scores={
                totalRounds : 3,
                selectedPlayer : 0,
                playerData:[
                    {
                      playerName: "Player 1",
                      currentRound: 1, fromPosition: 10, history: [], gameHistory: []
                    }
                ]
           };
            localStorage['scores']=JSON.stringify(scores);
            data=scores;
          }


        } else {
          alert('Sorry, your device doesnt appear to support local storage which sort of sux as it breask this app');
        }
      
        if(doReset) {
          window.location="index.html"
        }
        return data;
      },
      gotoNextPlayer: function() {
        //count the players we have already and then link the next one.
        var numPlayers=this.state.playerData.length;
        var nextPlayer=this.state.selectedPlayer+1;
        if(nextPlayer > (numPlayers-1) ) {nextPlayer=0;}
        var newPlayerName=this.state.playerData[nextPlayer].playerName;

        var newState=this.state;
        newState.selectedPlayer=nextPlayer;
        this.setState(newState);
        $(document.body).scrollTop($('#start').offset().top);
      
      },
      addNewPlayer: function() {
        //count the players we have already and then link to a new one.
        var newPlayer="Player " + (this.state.playerData.length+1);
        var newState=this.state;

        newState.playerData.push({
                playerName: newPlayer,
                currentRound: 1, fromPosition: 10, history: [], gameHistory: []
        });
        newState.selectedPlayer=newState.playerData.length-1;

        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        //$(document.body).scrollTop($('#start').offset().top);

      },
      handleDeleteHistoricGame:function(game) {
        var newState=this.state;
        var history=newState.playerData[this.state.selectedPlayer].gameHistory;
        history.splice(game, 1);
        newState.playerData[this.state.selectedPlayer].gameHistory=history;

        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
      },
      handleDeleteLastResult: function() {
        var newState=this.state;
        var history=newState.playerData[this.state.selectedPlayer].history;
        history.splice(history.length-1, 1);
        newState.playerData[this.state.selectedPlayer].currentRound=1+newState.playerData[this.state.selectedPlayer].history.length;
        newState.playerData[this.state.selectedPlayer].history=history;

        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);

      },
      handleScoreReset: function() {
        var playerState=this.state.playerData[this.state.selectedPlayer];
        var resetScores={playerName: playerState.playerName, currentRound: 1, fromPosition: 10, history: [], gameHistory: playerState.gameHistory };
        var newState=this.state;
        newState.playerData[this.state.selectedPlayer]=resetScores;
        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        
      },
      handleScoreResetAll: function() {

        var newState=this.state;
        this.state.playerData.map(function(data,index){
          var playerState=data;
          var resetScores={playerName: playerState.playerName, currentRound: 1, fromPosition: 10, history: [], gameHistory: playerState.gameHistory };
          newState.playerData[index]=resetScores;
        });
        
        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        alert('Scores have been reset for ALL players');
      },
      handleDeletePlayer: function() {

        var deletePlayerName=this.state.playerData[this.state.selectedPlayer].playerName;
        var numPlayers=this.state.playerData.length;

        var nextPlayer=this.state.selectedPlayer;
  
        if(nextPlayer >= (numPlayers-1) ) {nextPlayer=0;}
        var newPlayerName=this.state.playerData[nextPlayer].playerName;

        //deal with deleting last player
        if(numPlayers < 2) {nextPlayer=0; newPlayerName="Player 1"}


        var newState=this.state;
        newState.playerData.splice(this.state.selectedPlayer, 1);
        newState.selectedPlayer=nextPlayer;

        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        alert(deletePlayerName+' has been deleted');

      },
      handlePlayerLink: function(e) {    
        var newPlayerNum=($(e.target).attr('data-player'));
        var newState=this.state;
        newState.selectedPlayer=newPlayerNum;
        this.setState(newState);
         $(document.body).scrollTop($('#start').offset().top);
      },
      handlePlayerSettings: function(playerSettings) {    
       var newState=this.state;
       newState.playerData[this.state.selectedPlayer].playerName=playerSettings.playerName;
       this.setState(newState);
       localStorage['scores']=JSON.stringify(newState);
      },    
      handleScoreSubmit: function(score) {
        var playerState=this.state.playerData[this.state.selectedPlayer];
        var score=score.score;
        var nextRound=playerState.currentRound +1;
        var nextStartPosition=10;

              switch(parseInt(score)) {
                case 5:
                    nextStartPosition=10;
                    break;
                case 4:
                    nextStartPosition=9;
                    break;
                case 3:
                    nextStartPosition=8;
                    break;
               case 2:
                    nextStartPosition=7;
                    break;
               case 1:
                    nextStartPosition=6;
                    break;
               case 0:
                    nextStartPosition=5;
                    break;
                default:
                    //shouldnt ever get here!
                    nextStartPosition=5;
              }

          var historicScore = {
            round : playerState.currentRound,
            score : score,
            points : playerState.fromPosition*score, //same as points
            fromPosition : playerState.fromPosition
          };


          var historicScores=playerState.history;
          historicScores.push(historicScore);

          var gameScoreHistory=playerState.gameHistory;
          if(gameScoreHistory==undefined) {gameScoreHistory=[];}

          //store game history
          if(playerState.currentRound >= this.state.totalRounds) {
            var dateTime=new Date();
            var gameSummary={
              date: dateTime,
              scores: {
                  "5" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "6" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "7" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "8" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "9" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "10" : {scored: 0, numThrows: 0, points: 0, percent: 0},
                  "total":  {scored: 0, numThrows: 0, points: 0, percent: 0}
              }
            };

          var throwsPerTurn=5;
          var numThrows=playerState.history.length*throwsPerTurn;
          var totalPoints=0;
          

          playerState.history.map(function (data) {
            gameSummary.scores[data.fromPosition].scored=parseInt(gameSummary.scores[data.fromPosition].scored)+parseInt(data.score);
            gameSummary.scores[data.fromPosition].numThrows=parseInt(gameSummary.scores[data.fromPosition].numThrows)+throwsPerTurn;
            gameSummary.scores[data.fromPosition].points=parseInt(gameSummary.scores[data.fromPosition].points)+parseInt(data.points);


            gameSummary.scores['total'].scored=parseInt(gameSummary.scores['total'].scored)+parseInt(data.score);
            gameSummary.scores['total'].numThrows=parseInt(gameSummary.scores['total'].numThrows)+throwsPerTurn;
            gameSummary.scores['total'].points=parseInt(gameSummary.scores['total'].points)+parseInt(data.points);


          });  
          gameScoreHistory.push(gameSummary);
          }



          var newState=this.state;
          newState.playerData[this.state.selectedPlayer]={playerName:playerState.playerName, currentRound: nextRound, fromPosition: nextStartPosition, history: historicScores, gameHistory: gameScoreHistory};



          this.setState(newState);
          localStorage['scores']=JSON.stringify(newState);
        
      },


      render: function() { 

        var playerState=this.state.playerData[this.state.selectedPlayer];

        //calculate points!
        var accumulatedPoints=0;
        if(playerState) {
        playerState.history.map(function (data) {
          accumulatedPoints=accumulatedPoints+data.points;
        });
       }

        var scorePanel=<BasicPanel title="Round score"><ScoreForm handleScoreReset={this.handleScoreReset} showScoreButtons={playerState.currentRound <= this.state.totalRounds} showNextPlayer={this.state.playerData.length > 1} gotoNextPlayer={this.gotoNextPlayer} playerName={playerState.playerName}  round={playerState.currentRound} fromPosition={playerState.fromPosition} handleScoreSubmit={this.handleScoreSubmit}/></BasicPanel>;
        
        

        return (
          <div >
            <h1 id="start">Putting game scorer</h1><br />  
            <StatsPanel totalRounds={this.state.totalRounds} playerName={playerState.playerName} round={playerState.currentRound} fromPosition={playerState.fromPosition} totalPoints={accumulatedPoints}/>
            {scorePanel}
             <BasicPanel title="Statistics">
              <RoundGraphs roundData={playerState.history}/>
            </BasicPanel>
            <HistoryPanel handleDeleteLastResult={this.handleDeleteLastResult} playerName={playerState.playerName}  history={playerState.history} />
          <BasicPanel title="Game history"><GameHistory deleteGameHandler={this.handleDeleteHistoricGame} history={playerState.gameHistory}/></BasicPanel>
            <BasicPanel title="Player settings"><PlayerSettingsForm handlePlayerSettings={this.handlePlayerSettings}playerName={playerState.playerName} /></BasicPanel>

            <PlayerList handlePlayerLink={this.handlePlayerLink} players={this.state.playerData} currentPlayer={this.state.selectedPlayer} addNewPlayer={this.addNewPlayer} />
            <ResetPanel handleScoreResetAll={this.handleScoreResetAll} handleDeletePlayer={this.handleDeletePlayer} handleScoreReset={this.handleScoreReset} />
            <br /><br /><CDGCPanel />

          </div>
        );
      }
    });


      React.render(
        <Page  />,
        document.getElementById('content')
      );

      /*------------------ utils  */


      function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }



    </script>
    <script src="bootstrap/js/bootstrap.js"> </script>
  </body>
</html>