<html>
  <head>
    <title>Putting Game Scorer</title>
    <script src="lib/underscore-min.js"></script>
    <script src="lib/react-0.12.2.js"></script>
    <script src="lib/JSXTransformer-0.12.2.js"></script>
    <script src="lib/jquery-1.10.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link href="bootstrap/css/orig.bootstrap.min.css" rel="stylesheet" >
    <link href="style.css" rel="stylesheet" >
  </head>
  <body>
    <div id="content" class="container">
      Loading...
    </div>
    <script type="text/jsx">

    /* 
      work in progress !!
      james@5point6.net on behalf of the disc golf community 
    */

    var globalData = {
      totalRounds : 20 //total number of rounds to play
    };

      //History row
      var HistoryPanel = React.createClass({
        render: function() {

          var accumulatedPoints=0;
          var rows = this.props.history.map(function (data) {
            accumulatedPoints=accumulatedPoints+data.points;
            return (
              <HistoryRow round={data.round} fromPosition={data.fromPosition} score={data.score} points={data.points} totalPoints={accumulatedPoints}/>
              );
          });

          var panelTitle="Round history for "+ this.props.playerName;

          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">{panelTitle}</h3>
                  </div>                  
                  <div className="panel-body" >
                      <table className="table table-striped">
                        <thead><td>#</td><td>From</td><td>Score</td><td>Points</td><td>Total</td></thead>
                        <tbody>
                          {rows}
                        </tbody>
                      </table>
                  <div className="well text-center" >
                    You can copy and paste these details and email yourself!
                  </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }
      });


      //History row
      var HistoryRow = React.createClass({
        render: function() {
          return (
            <tr>
              <td>{this.props.round}</td>
              <td>{this.props.fromPosition+'m'}</td>
              <td>{this.props.score}</td>
              <td>{this.props.points}</td>
              <td>{this.props.totalPoints}</td>

            </tr>
          );
        }
      });

      //Container for form
      var ScorePanel = React.createClass({
        render: function() {
          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">Round score</h3>
                  </div>                  
                  <div className="panel-body" >{this.props.children}</div>
                </div>
              </div>
            </div>
          );
        }
      });

    //Score submit form
     var ScoreForm = React.createClass({
      gotoNextPlayer : function() {
        this.props.gotoNextPlayer();
      },
      handleSubmit: function(e) {
        e.preventDefault();

        var score = e.target.value;

        if(score >=0 && score <=5) {
          //pass to parent handler
          this.props.handleScoreSubmit({score: score});
        } else {
          alert('Bad score, must be between 0 and 5!')
        }
        $(document.body).scrollTop($('#start').offset().top);

        
      },
      render: function() {
        var nextPlayer=<div><div>&nbsp;</div>  
              <div className="text-center">
                 <button type="button" className="btn btn-info" onClick={this.gotoNextPlayer} value="0" type="submit" >Next player</button>
              </div></div>
        if(!this.props.showNextPlayer) {nextPlayer="";}

        return (
          <form  onSubmit={function(e) {e.preventDefault()}} >
            <div className="row" >
                <div className="col-xs-12 text-center">Enter score for <strong>{this.props.playerName}</strong> for round <strong>{this.props.round}</strong> (from {this.props.fromPosition+'m'})<br /><br /></div>
            </div>
              <div className="text-center">
                       <button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="0" type="submit" >&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="1" type="submit" >&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="2" type="submit" >&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;</button>
                </div>
              <div>&nbsp;</div>  
                <div className="text-center">
                       <button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="3" type="submit" >&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="4" type="submit" >&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;</button>
                { " " }<button type="button" className="btn btn-lg btn-primary" onClick={this.handleSubmit} value="5" type="submit" >&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;</button>
                </div>
             {nextPlayer}

          </form>
        );
      }
    });



      //Stats panel
      var StatsPanel = React.createClass({
        render: function() {
          var numberStyle={fontSize: "40px", fontWeight: "bold"};
          var numberUnitStyle={fontSize: "20px", fontWeight: "bold"};
          var progress=Math.floor(((this.props.round-1)/globalData.totalRounds) * 100) +"%";
          var gameScoreLine;

          if(this.props.round > globalData.totalRounds) {
                gameScoreLine=<div>
                <div  className="well" >
                  <div className="row">
                        <div className="col-xs-12 text-center">
                          <p style={numberStyle}>Total  {this.props.totalPoints}</p>
                        </div>

                  </div>
                </div>
                <ProgressBar progress={progress} />
                </div>
                ;


          } else {

             gameScoreLine=<div>
                  <div  className="well" >
                  <div className="row">
                      <div className="col-xs-4 text-center">
                        Round
                      </div>
                      <div className="col-xs-4 text-center">
                        Position
                      </div>
                      <div className="col-xs-4 text-center">
                        Points
                      </div>
                    </div>
                    <div className="row">
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >#{this.props.round}</p>
                      </div>
                      <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{this.props.fromPosition}<span style={numberUnitStyle}>m</span></p>
                      </div>
                       <div className="col-xs-4 text-center">
                        <p style={numberStyle} >{this.props.totalPoints}</p>
                      </div>
                    </div>
                  </div>
                    <ProgressBar progress={progress} />
                  </div>;

           }
          var playerName=this.props.playerName;
          return (
            <div className="row">
              <div className="col-xs-12 col-md-5">
                <div className="panel panel-primary">
                  <div className="panel-heading">
                    <h3 className="panel-title">{playerName}</h3>
                  </div>                  
                  <div className="panel-body" >
                      {gameScoreLine}
                  </div>
                </div>
              </div>
            </div>
          );
        }
      });

    var ProgressBar = React.createClass({
      render: function() {
        var progressStyle={width: this.props.progress};
        return(
        <div className="progress">
          <div className="progress-bar progress-bar-striped" role="progressbar"  style={progressStyle}>{this.props.progress}</div>
        </div>);
      }

    });


    var ResetPanel = React.createClass({
      handleReset : function() {
          this.props.handleScoreReset();
      },
      handleDeletePlayer: function() {
          this.props.handleDeletePlayer();
      },
      handleResetAll: function() {
          this.props.handleScoreResetAll();
      },
      render: function() {
        return(
          <div>
            <div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Reset scores&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleReset} role="presentation"><a role="menuitem" tabindex="-1" href="#">Confirm, reset just this players scores</a></li>
                    <li onClick={this.handleResetAll} role="presentation"><a role="menuitem" tabindex="-1" href="#">Confirm, reset <strong>ALL</strong> players scores</a></li>
                  </ul>
             </div> 
     
              { " " }<div className="btn-group">
                  <button className="btn btn-danger dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" >
                    Delete player&nbsp;
                    <span className="caret"></span>
                  </button>
                  <ul className="dropdown-menu" role="menu" >
                    <li onClick={this.handleDeletePlayer} role="presentation"><a role="menuitem" tabindex="-1" href="#">Confirm, delete this player</a></li>
                  </ul>
                </div>  
   
        

        </div>

       );
      }

    });


    var CDGCPanel = React.createClass({
      handleReset : function() {
          this.props.handleScoreReset();
      },
      render: function() {
        var center={textAlign:"center"}
        return(
          <div className="row">
              <div className="col-xs-12 col-md-5">
            <div style={center}>
              <a target="_blank" href="http://www.croydondiscgolf.com">
                <img src="images/cdgc.png" alt="Croydon Disc Golf Club" />
              </a>
              <p className="text-center">Croydon Disc Golf Club</p>
              <p className="text-center">London{"\'"}s only fully basketed disc golf course </p>
              <p className="text-center"><em>v0.1 Super beta!</em></p>
            </div>
          </div>
          </div>

       );
      }

    });

  
   var PlayerListRow = React.createClass({
      render: function(){
        var playerLink="?player="+this.props.name;
        var currentPlayerStyle={};
        if(this.props.selected) {currentPlayerStyle={fontWeight:"bold"};}

        return (
            <tr>
              <td><a style={currentPlayerStyle} href={playerLink}>{this.props.name}</a></td>
              <td>{this.props.round}</td>
              <td>{this.props.nextPosition + 'm'}</td>
              <td>{this.props.points}</td>
            </tr>
          );       
      }
    }); 

  var PlayerList = React.createClass({
      handleAddPlayer: function() {
        this.props.addNewPlayer();
      },
      render: function(){
       
        var currentPlayer=this.props.currentPlayer;
        var rows = this.props.players.map(function (data,index) {
          var accumulatedPoints=0;
          data.history.map(function (data) {
            accumulatedPoints=accumulatedPoints+data.points;
          });



          return (
            <PlayerListRow selected={currentPlayer==index} name={data.playerName} round={data.currentRound-1} nextPosition={data.fromPosition} points={accumulatedPoints}/>
            );
        });
        return (
          <div className="row">
            <div className="col-xs-12 col-md-5">
              <div className="panel panel-primary">
                <div className="panel-heading">
                  <h3 className="panel-title">Players</h3>
                </div>                  
                <div className="panel-body" >
                   <table className="table table-striped">
                    <thead><td>Player</td><td>Played</td><td>Next</td><td>Points</td></thead>
                    <tbody>
                      {rows}
                    </tbody>
                  </table>
                  <div className="text-center">
                    <button className="btn btn-info" onClick={this.handleAddPlayer}>Add another player</button> 
                  </div>

                </div>
              </div>
            </div>
          </div> 
          );       
      }
    }); 


    var Page = React.createClass({
      getInitialState: function() {

        //load settings from local storage
        var data=false;
        var returnData;

        //get player from url
        var player=getParameterByName('player');
        if (player=="" || player == undefined) {player='Player 1'}
       

        if(typeof(Storage)!=='undefined') {
          
          //get pre-existing data store
          if(localStorage['scores']) {
            data=JSON.parse(localStorage['scores']);
          }

          //first run, create a default the data storage object
          if(!data) {
            var scores={
                totalRounds : 20,
                selectedPlayer : 0,
                playerData:[
                    {
                      playerName: player,
                      currentRound: 1, fromPosition: 10, history: [] 
                    }
                ]
           };
            localStorage['scores']=JSON.stringify(scores);
            data=scores;
          }

          //determine if the player is new, if so create them a data store and add to the store object
          //otherwise make htem the selected player
          var existingPlayer=false;
          _.each(data.playerData, function(element, index, list) {
            if(element.playerName==player) {
              existingPlayer=true;
              data.selectedPlayer=index;
            }
          });

          if(!existingPlayer) {
            data.playerData.push({
                      playerName: player,
                      currentRound: 1, fromPosition: 10, history: [] 
            });
            data.selectedPlayer=data.playerData.length-1;
            localStorage['scores']=JSON.stringify(data);
          }

        } else {
          alert('Sorry, your device doesnt appear to support local storage which sort of sux as it breask this app');
        }
        console.log(data);
        return data;
      },
      gotoNextPlayer: function() {
        //count the players we have already and then link the next one.
        var numPlayers=this.state.playerData.length;
        var nextPlayer=this.state.selectedPlayer+1;
        if(nextPlayer > (numPlayers-1) ) {nextPlayer=0;}
        var newPlayerName=this.state.playerData[nextPlayer].playerName;
        window.location.href="?player="+newPlayerName;
      },
      addNewPlayer: function() {
        //count the players we have already and then link to a new one.
        var newPlayer="Player " + (this.state.playerData.length+1);
        window.location.href="?player="+newPlayer;
      },
      handlePlayerSettignsSubmit: function(){
        console.log('player settings changed');
      },
      handleScoreReset: function() {
        var playerState=this.state.playerData[this.state.selectedPlayer];
        var resetScores={playerName: playerState.playerName, currentRound: 1, fromPosition: 10, history: [] };
        var newState=this.state;
        newState.playerData[this.state.selectedPlayer]=resetScores;
        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        alert('Scores have been reset for this player');
      },
      handleScoreResetAll: function() {

        var newState=this.state;
        this.state.playerData.map(function(data,index){
          var playerState=data;
          var resetScores={playerName: playerState.playerName, currentRound: 1, fromPosition: 10, history: [] };
          newState.playerData[index]=resetScores;
        });
        
        localStorage['scores']=JSON.stringify(newState);
        this.setState(newState);
        alert('Scores have been reset for ALL players');
      },
      handleDeletePlayer: function() {
        var deletePlayerName=this.state.playerData[this.state.selectedPlayer].playerName;
        var numPlayers=this.state.playerData.length;
        var nextPlayer=this.state.selectedPlayer+1;
        if(nextPlayer > (numPlayers-1) ) {nextPlayer=0;}
        var newPlayerName=this.state.playerData[nextPlayer].playerName;

        //deal with deleting last player
        if(numPlayers < 2) {nextPlayer=0; newPlayerName="Player 1"}
        

        var newState=this.state;
        newState.playerData.splice(this.state.selectedPlayer, 1);
        localStorage['scores']=JSON.stringify(newState);

        window.location.href="?player="+newPlayerName;
        alert(deletePlayerName+' has been deleted');
      },
      handleScoreSubmit: function(score) {
        var playerState=this.state.playerData[this.state.selectedPlayer];
        var score=score.score;
        var nextRound=playerState.currentRound +1;
        var nextStartPosition=10;

              switch(score) {
                case 5:
                    nextStartPosition=10;
                    break;
                case 4:
                    nextStartPosition=9;
                    break;
                case 3:
                    nextStartPosition=8;
                    break;
               case 2:
                    nextStartPosition=7;
                    break;
               case 1:
                    nextStartPosition=6;
                    break;
               case 0:
                    nextStartPosition=5;
                    break;
                default:
                    //shouldnt ever get here!
                    nextStartPosition=5;
              }

          var historicScore = {
            round : playerState.currentRound,
            score : score,
            points : playerState.fromPosition*score, //same as points
            fromPosition : playerState.fromPosition
          };


          var historicScores=playerState.history;
          historicScores.push(historicScore);
          var newState=this.state;
          newState.playerData[this.state.selectedPlayer]={playerName:playerState.playerName, currentRound: nextRound, fromPosition: nextStartPosition, history: historicScores};

          this.setState(newState);
          localStorage['scores']=JSON.stringify(newState);
        
      },


      render: function() { 

        var playerState=this.state.playerData[this.state.selectedPlayer];

        //calculate points!
        var accumulatedPoints=0;
        playerState.history.map(function (data) {
          accumulatedPoints=accumulatedPoints+data.points;
        });

        var scorePanel="";
        if(playerState.currentRound <= this.state.totalRounds) {
            scorePanel= <ScorePanel><ScoreForm showNextPlayer={this.state.playerData.length > 1} gotoNextPlayer={this.gotoNextPlayer} playerName={playerState.playerName}  round={playerState.currentRound} fromPosition={playerState.fromPosition} handleScoreSubmit={this.handleScoreSubmit}/></ScorePanel>;
        }
        return (
          <div >
            <h1 id="start">Putting game scorer</h1><br />  
            <StatsPanel playerName={playerState.playerName} round={playerState.currentRound} fromPosition={playerState.fromPosition} totalPoints={accumulatedPoints}/>
            {scorePanel}
            <HistoryPanel playerName={playerState.playerName}  history={playerState.history} />
            <PlayerList players={this.state.playerData} currentPlayer={this.state.selectedPlayer} addNewPlayer={this.addNewPlayer} />
            <ResetPanel handleScoreResetAll={this.handleScoreResetAll} handleDeletePlayer={this.handleDeletePlayer} handleScoreReset={this.handleScoreReset} />
            <br /><br /><CDGCPanel />

          </div>
        );
      }
    });


      React.render(
        <Page  />,
        document.getElementById('content')
      );

      /*------------------ utils  */


      function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }


    </script>
    <script src="bootstrap/js/bootstrap.js"> </script>
  </body>
</html>